<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organizer - Fest Entry</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #ff758c, #ff7eb3);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      min-height: 100vh;
      margin: 0;
    }
    .container {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      width: 360px;
      text-align: center;
    }
    h2 { margin-bottom: 15px; }
    button {
      padding: 10px 15px;
      background: #ff758c;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 6px 0;
      width: 100%;
      font-size: 16px;
    }
    button:hover { background: #ff4f70; }
    input { margin: 6px 0; padding: 8px; width: 90%; border-radius: 6px; border: 1px solid #ccc; }
    .scan-area { width: 100%; aspect-ratio: 4/3; background: #000; color: #fff; margin: 12px 0; display:flex; align-items:center; justify-content:center; border-radius:8px; }
    .list-box { max-height: 250px; overflow:auto; border:1px solid #ddd; padding:10px; border-radius:8px; background:#f9f9f9; text-align:left; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Organizer Dashboard</h2>
    <button id="pay-btn">Pay to Access Organizer</button>

    <div id="organizer-panel" style="display:none">
      <button id="start-scan">Start QR Scanner</button>
      <button id="stop-scan" style="display:none">Stop Scanner</button>
      <div id="reader" class="scan-area">Scanner inactive</div>

      <div style="margin-top:12px">
        <input type="file" id="file-input" accept=".xlsx,.xls,.csv,text/csv">
        <button id="import-file">Upload Excel/CSV</button>
      </div>

      <h3>Allowed Roll Numbers</h3>
      <div id="allowed-list" class="list-box">No entries yet</div>
      <button id="clear-list">Clear Allowed List</button>
    </div>
  </div>

  <script>
    // ---------- Payment simulation ----------
    const payBtn = document.getElementById('pay-btn');
    const organizerPanel = document.getElementById('organizer-panel');
    payBtn.addEventListener('click', () => {
      alert('Payment successful! Organizer access granted.');
      payBtn.style.display = 'none';
      organizerPanel.style.display = 'block';
    });

    // ---------- Allowed list storage ----------
    const STORAGE_KEY = "festentry_allowed_v2"; 
    function loadAllowed() {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    }
    function saveAllowed(list) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
      renderAllowed();
    }
    function renderAllowed() {
      const box = document.getElementById('allowed-list');
      const list = loadAllowed();
      if (!list.length) {
        box.innerHTML = '<div>No entries yet</div>';
        return;
      }
      box.innerHTML = list.map((entry,i)=>`${i+1}. Roll: ${entry.rollNo}, T-Shirt: ${entry.shirtSize}`).join('<br>');
    }
    renderAllowed();

    document.getElementById('clear-list').addEventListener('click', () => {
      if (!confirm('Clear allowed list?')) return;
      saveAllowed([]);
      alert('Allowed list cleared.');
    });

    // ---------- Excel / CSV import ----------
    document.getElementById('import-file').addEventListener('click', () => {
      const f = document.getElementById('file-input').files[0];
      if (!f) { alert('Select a file first'); return; }

      const reader = new FileReader();
      reader.onload = (ev) => {
        const data = ev.target.result;
        let workbook;
        try {
          if (typeof data === 'string') workbook = XLSX.read(data, { type: 'binary' });
          else workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
        } catch(err) { alert('Error reading file: ' + err); return; }

        const first = workbook.SheetNames[0];
        const sheet = workbook.Sheets[first];
        const rows = XLSX.utils.sheet_to_json(sheet, { header:1 });
        const vals = rows.map(r=>r[0]?String(r[0]).trim().toUpperCase():null).filter(Boolean);
        if (!vals.length) { alert('No values found'); return; }

        const allowed = loadAllowed();
        vals.forEach(v => {
          if (!allowed.some(e => e.rollNo === v)) {
            allowed.push({ rollNo: v, shirtSize: 'N/A' });
          }
        });
        saveAllowed(allowed);
        alert(`Imported ${vals.length} entries. Total allowed: ${allowed.length}`);
      };

      if (f.name.toLowerCase().endsWith('.csv') || f.type==='text/csv') reader.readAsText(f);
      else reader.readAsArrayBuffer(f);
    });

    // ---------- QR Scanner ----------
    let scanner = null;
    const readerDiv = document.getElementById('reader');
    const startBtn = document.getElementById('start-scan');
    const stopBtn = document.getElementById('stop-scan');

    startBtn.addEventListener('click', async () => {
      scanner = new Html5Qrcode("reader");
      const devices = await Html5Qrcode.getCameras();
      if (!devices || devices.length===0) { alert('No camera found'); return; }
      const cameraId = devices[0].id;

      await scanner.start(
        cameraId,
        { fps: 10, qrbox:250 },
        (decodedText, decodedResult) => {
          // You can handle the scanned QR here
          console.log('Scanned:', decodedText);
        },
        errMsg => {}
      );

      startBtn.style.display='none';
      stopBtn.style.display='inline-block';
    });

    stopBtn.addEventListener('click', async () => {
      if (scanner) {
        try { await scanner.stop(); } catch(e){}
        scanner.clear();
        scanner = null;
      }
      readerDiv.textContent = "Scanner inactive";
      startBtn.style.display='inline-block';
      stopBtn.style.display='none';
    });

  </script>
</body>
</html>
<link rel="stylesheet" href="style.css">
